@page "/admin/edit/posts/{id:int}"
@using PPTWebApp.Data.Models
@using PPTWebApp.Data.Services
@inject PostService PostService
@inject NavigationManager NavigationManager

<div class="post-editor-container"> 
    <h2>Edit Post</h2>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }
    else if (post == null)
    {
        <div>Loading post details...</div>
    }
    else
    {
        <EditForm Model="post" OnValidSubmit="SaveChanges">
            <div class="form-group">
                <label for="title">Post Title</label>
                <InputText id="title" class="form-control" @bind-Value="post.Title" />
            </div>

            <div class="form-group">
                <label for="author">Author</label>
                <InputText id="author" class="form-control" @bind-Value="post.Author" />
            </div>

            <div class="form-group">
                <label for="datePosted">Date Posted</label>
                <InputDate id="datePosted" class="form-control" @bind-Value="post.DatePosted" readonly />
            </div>

            <div class="form-group">
                <label for="imageurl">Image URL</label>
                <InputText id="imageurl" class="form-control" @bind-Value="post.ImageUrl" />
            </div>

            <div class="form-group">
                <label for="imagecompromise">Image Compromise</label>
                <InputSelect id="imagecompromise" class="form-control" @bind-Value="post.ImageCompromise">
                    <option value="horizontal">Horizontal</option>
                    <option value="vertical">Vertical</option>
                    <option value="auto">Auto</option>
                    <option value="never">Never</option>
                </InputSelect>
            </div>

            <div class="form-group">
                <label for="contentUpload">Upload New HTML Content</label>
                <InputFile OnChange="HandleContentFileUpload" />
            </div>

            <button type="submit" class="btn btn-primary">Save Changes</button>
        </EditForm>
    }
</div>

@code {
    [Parameter] public int id { get; set; }
    private Post? post;
    private string errorMessage = string.Empty;
    private IBrowserFile? uploadedFile;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            post = await PostService.GetPostByIdAsync(id, CancellationToken.None);
            if (post == null)
            {
                errorMessage = "Post not found.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading post: {ex.Message}";
        }
    }

    private async Task HandleContentFileUpload(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
        if (uploadedFile != null)
        {
            try
            {
                var filePath = Path.Combine("wwwroot", "uploads", $"{post.Id}.html");
                using var stream = uploadedFile.OpenReadStream();
                using var fileStream = new FileStream(filePath, FileMode.Create);
                await stream.CopyToAsync(fileStream);
            }
            catch (Exception ex)
            {
                errorMessage = $"Error uploading HTML file: {ex.Message}";
            }
        }
    }

    private async Task SaveChanges()
    {
        if (post != null)
        {
            try
            {
                await PostService.UpdatePostAsync(post, CancellationToken.None);
                NavigationManager.NavigateTo("/admin/posts");
            }
            catch (Exception ex)
            {
                errorMessage = $"Error saving post: {ex.Message}";
            }
        }
    }
}
